# 数据库版本升级备份建议

## 一、当前升级情况分析

### 升级内容
- **版本号**：5 → 6
- **变更类型**：**新增表**（不修改现有表结构）
- **新增表**：`note_comments`（评论表）
- **影响范围**：只新增表，不影响现有数据

### 风险等级：**低风险** ⭐⭐☆☆☆

**原因**：
1. ✅ 只新增表，不修改现有表结构
2. ✅ 使用 `CREATE TABLE IF NOT EXISTS`，表已存在不会报错
3. ✅ 使用 `CREATE INDEX IF NOT EXISTS`，索引已存在不会报错
4. ✅ SQLite的 `onUpgrade()` 在事务中执行，出错会回滚
5. ✅ 没有删除或修改现有数据

**但仍有风险**：
- ⚠️ 如果升级过程中程序崩溃，可能导致数据库损坏
- ⚠️ 外键约束创建失败可能导致表结构不完整
- ⚠️ 多个项目数据库都需要升级

---

## 二、备份方案

### 方案1：手动导出数据（推荐，最简单）

**适用场景**：开发/测试环境，或数据量不大的情况

**操作步骤**：
1. 打开应用
2. 菜单 → "导出" → 选择"导出为JSON"（推荐）或"导出为CSV"
3. 保存导出的文件到安全位置
4. 然后进行数据库升级

**优点**：
- ✅ 操作简单
- ✅ 可以验证数据完整性
- ✅ 导出文件可以随时导入恢复

**缺点**：
- ❌ 需要手动操作
- ❌ 如果忘记备份就升级了，无法恢复

---

### 方案2：Android系统自动备份（已启用）

**当前状态**：
- ✅ `AndroidManifest.xml` 中已设置 `android:allowBackup="true"`
- ✅ 已配置 `backup_rules.xml` 和 `data_extraction_rules.xml`

**备份内容**：
- 数据库文件（在 `/data/data/包名/databases/` 目录下）
- SharedPreferences
- 其他应用数据

**恢复方式**：
- 卸载重装应用后，系统会自动恢复备份数据
- 或通过ADB命令恢复

**优点**：
- ✅ 自动备份，无需手动操作
- ✅ 系统级备份，可靠性高

**缺点**：
- ❌ 需要系统支持（Android 6.0+）
- ❌ 备份可能不及时（系统决定备份时机）
- ❌ 恢复需要卸载重装应用

---

### 方案3：在升级前自动备份数据库文件（可选实现）

**实现思路**：在 `onUpgrade()` 执行前，先备份数据库文件

**优点**：
- ✅ 自动备份，无需手动操作
- ✅ 备份文件就在应用目录，容易找到
- ✅ 可以快速恢复

**缺点**：
- ❌ 需要额外实现代码
- ❌ 占用存储空间

---

## 三、推荐方案

### 对于开发/测试环境
**推荐：方案1（手动导出）**
- 操作简单
- 可以验证数据
- 导出文件可以用于测试导入功能

### 对于生产环境
**推荐：方案1 + 方案2（双重保障）**
1. 升级前手动导出所有项目的数据
2. 依赖Android系统自动备份作为第二道防线

---

## 四、升级前检查清单

### 必须检查
- [ ] 确认所有重要数据已导出（JSON格式）
- [ ] 确认导出文件可以正常打开
- [ ] 确认有足够的存储空间（升级过程需要）

### 建议检查
- [ ] 确认Android系统备份已启用
- [ ] 确认应用有足够的权限
- [ ] 确认当前没有其他操作在进行

---

## 五、升级失败后的恢复方案

### 如果升级失败导致数据库损坏

**方案A：从导出文件恢复**
1. 卸载应用（会删除损坏的数据库）
2. 重新安装应用
3. 使用导入功能恢复数据

**方案B：从系统备份恢复**
1. 卸载应用
2. 重新安装应用
3. 系统会自动恢复备份数据（如果可用）

**方案C：手动恢复数据库文件**
1. 如果有备份的数据库文件
2. 使用ADB命令恢复：
   ```bash
   adb push backup.db /data/data/包名/databases/notes.db
   ```

---

## 六、当前升级的安全性评估

### 本次升级（版本5→6）的安全性

**安全措施**：
1. ✅ 使用 `CREATE TABLE IF NOT EXISTS`（表已存在不会报错）
2. ✅ 使用 `CREATE INDEX IF NOT EXISTS`（索引已存在不会报错）
3. ✅ 使用 `try-catch` 包裹索引创建（即使失败也不影响）
4. ✅ 只新增表，不修改现有表结构
5. ✅ 外键约束使用 `ON DELETE CASCADE`（安全）

**潜在风险点**：
1. ⚠️ 外键约束创建失败（如果表已存在但结构不对）
2. ⚠️ 多个项目数据库需要逐个升级（每个项目一个数据库）

**结论**：
- **风险等级：低**
- **建议：开发/测试环境可以放心升级，生产环境建议先导出数据**

---

## 七、如果添加自动备份功能（可选）

### 实现思路

在 `NoteDbHelper.onUpgrade()` 开始时，先备份数据库文件：

```java
@Override
public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    // 在升级前备份数据库
    if (oldVersion < 6) {
        backupDatabase();
    }
    
    // 执行升级逻辑
    // ...
}

private void backupDatabase() {
    try {
        File dbFile = getDatabasePath(DATABASE_NAME);
        if (dbFile.exists()) {
            String backupName = DATABASE_NAME + ".backup." + System.currentTimeMillis();
            File backupFile = new File(dbFile.getParent(), backupName);
            // 复制数据库文件
            // ...
        }
    } catch (Exception e) {
        // 备份失败不影响升级
    }
}
```

**优点**：
- 自动备份，无需手动操作
- 备份文件就在应用目录

**缺点**：
- 需要额外实现
- 占用存储空间
- 需要处理多个项目的数据库备份

---

## 八、总结

### 当前建议

**对于本次升级（版本5→6）**：
1. ✅ **开发/测试环境**：可以直接升级，风险很低
2. ⚠️ **生产环境**：建议先手动导出数据（使用应用的导出功能）
3. ✅ **Android系统备份**：已启用，作为第二道防线

### 操作建议

**升级前**：
1. 打开应用
2. 菜单 → "导出" → "导出为JSON"
3. 保存导出的文件
4. 然后进行应用更新

**升级后**：
1. 检查应用是否正常运行
2. 检查数据是否完整
3. 测试新功能（评论功能）

**如果出现问题**：
1. 卸载应用
2. 重新安装
3. 使用导入功能恢复数据

---

## 九、数据库文件位置

### 数据库文件路径
```
/data/data/person.notfresh.noteplus/databases/
├── notes.db          (默认项目)
├── project1_notes.db (项目1)
├── project2_notes.db (项目2)
└── ...
```

### 查看数据库文件（需要root或ADB）
```bash
# 使用ADB查看
adb shell
run-as person.notfresh.noteplus
cd databases
ls -la
```

---

## 十、快速检查命令

### 检查数据库版本（需要root或ADB）
```bash
adb shell
run-as person.notfresh.noteplus
sqlite3 databases/notes.db "PRAGMA user_version;"
```

### 检查表是否存在
```bash
sqlite3 databases/notes.db ".tables"
```

### 检查note_comments表结构
```bash
sqlite3 databases/notes.db ".schema note_comments"
```

