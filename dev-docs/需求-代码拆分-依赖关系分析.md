# MainActivity 依赖关系分析

## 一、核心依赖树（主分支）

### 1. 生命周期层（根节点）
```
onCreate()
├── 初始化视图和Manager
├── loadSettings()           [叶分支：设置加载]
├── loadFoldedNoteIds()     [叶分支：折叠状态]
└── loadMoments()            [核心：笔记列表加载]

onResume()
└── ReminderScheduler        [叶分支：提醒功能]

onDestroy()
└── 资源清理
```

### 2. 笔记核心功能（主干）
```
saveMoment()                 [核心入口]
├── 验证时间范围             [依赖：hasTimeRange, startCalendar, endCalendar]
├── 验证花费                 [依赖：costEditText]
├── 保存笔记到数据库         [依赖：dbHelper]
├── 保存时间范围             [依赖：dbHelper.saveTimeRange()]
├── 保存标签关联             [依赖：selectedTags, dbHelper.linkNoteToTag()]
├── clearForm()              [依赖：多个UI组件]
└── loadMoments()            [核心：刷新列表]

loadMoments()                [核心：列表加载]
├── 查询数据库               [依赖：dbHelper]
├── 创建Adapter              [依赖：SimpleCursorAdapter]
├── getView()                [核心：列表项渲染]
│   ├── updateListItemWithExtras()  [核心：添加额外信息]
│   │   ├── addTimeRangeInfo()      [叶分支：时间范围显示]
│   │   └── addTagsInfo()           [叶分支：标签显示]
│   ├── checkAndShowFoldButton()    [叶分支：折叠功能]
│   └── 多选模式处理                [叶分支：多选功能]
└── 设置点击监听器

deleteNote()                 [核心：删除笔记]
├── 删除数据库记录           [依赖：dbHelper]
└── loadMoments()            [核心：刷新列表]

getNoteContentById()         [核心：获取笔记内容]
└── 查询数据库               [依赖：dbHelper]
```

### 3. 菜单和事件分发（路由层）
```
onOptionsItemSelected()      [路由入口]
├── showProjectMenu()        [叶分支：项目管理]
├── showExportDialog()       [叶分支：导出]
├── showImportDialog()       [叶分支：导入]
├── showRecycleBinDialog()   [叶分支：回收站]
├── showSettingsDialog()     [叶分支：设置]
├── toggleMultiSelectMode()  [叶分支：多选模式]
└── showMoveToProjectDialog() [叶分支：移动笔记]

onItemLongClickListener      [路由入口]
└── showNoteOptionsMenu()    [核心：笔记操作菜单]
    ├── copyToClipboard()    [叶分支：复制]
    └── deleteNote()         [核心：删除]
```

---

## 二、叶分支（独立功能模块）

### 1. 导入导出模块（完全独立）
```
showExportDialog()
└── exportData()
    ├── writeCsvData()       [独立：CSV写入]
    └── writeJsonData()     [独立：JSON写入]

showImportDialog()
└── importData()
    ├── showImportTargetDialog()
    ├── readCsvData()        [独立：CSV读取]
    └── readJsonData()       [独立：JSON读取]

依赖关系：
- 只依赖：dbHelper, projectManager
- 被调用：onOptionsItemSelected()
- 调用核心：loadMoments()（导入后刷新）
```

### 2. 项目管理模块（相对独立）
```
showProjectMenu()
└── showProjectManagementDialog()
    ├── showCreateProjectDialog()
    ├── showSelectProjectForRename()
    ├── showSelectProjectForDefault()
    ├── showSelectProjectForDelete()
    └── showRecycleBinDialog()

switchProject()              [核心：切换项目]
├── 关闭旧数据库
├── 打开新数据库
├── loadSettings()          [依赖：设置]
├── loadFoldedNoteIds()     [依赖：折叠状态]
└── loadMoments()           [核心：加载列表]

依赖关系：
- 依赖：projectManager, dbHelper
- 被调用：onOptionsItemSelected(), showProjectMenu()
- 调用核心：loadMoments(), loadSettings()
```

### 3. 回收站模块（完全独立）
```
showRecycleBinDialog()
├── showRecycleBinItemOptionsDialog()
│   ├── restoreProjectFromRecycleBin()  [projectManager方法]
│   └── showPermanentDeleteConfirmation()
└── showEmptyRecycleBinConfirmation()

依赖关系：
- 只依赖：projectManager
- 被调用：onOptionsItemSelected(), showProjectManagementDialog()
- 不调用核心功能
```

### 4. 标签管理模块（半独立）
```
showTagSelectionDialog()     [UI入口]
└── addTagChip()            [UI操作]
    └── 添加到selectedTags列表

addTagsInfo()                [显示标签]
└── 查询数据库获取标签       [依赖：dbHelper.getTagsForNote()]

依赖关系：
- 依赖：dbHelper, Tag model
- 被调用：saveMoment()（保存时）, loadMoments()（显示时）
- 状态：selectedTags（在MainActivity中）
```

### 5. 时间范围模块（半独立）
```
initTimeDialogs()           [初始化]
showTimePicker()            [UI操作]
addTimeRangeInfo()          [显示时间范围]
└── 查询数据库获取时间范围   [依赖：dbHelper.getTimeRangesForNote()]

依赖关系：
- 依赖：dbHelper, Calendar, TimePickerDialog
- 被调用：saveMoment()（保存时）, loadMoments()（显示时）
- 状态：hasTimeRange, startCalendar, endCalendar（在MainActivity中）
```

### 6. 折叠功能模块（半独立）
```
loadFoldedNoteIds()         [加载状态]
saveFoldedNoteIds()         [保存状态]
toggleNoteFold()            [切换折叠]
checkAndShowFoldButton()    [显示折叠按钮]

依赖关系：
- 依赖：dbHelper（存储折叠状态）
- 被调用：onCreate(), loadMoments(), toggleNoteFold()
- 状态：foldedNoteIds（在MainActivity中）
```

### 7. 多选模式模块（相对独立）
```
toggleMultiSelectMode()
exitMultiSelectMode()
updateMultiSelectMenu()
showMoveToProjectDialog()
└── moveNotesToProject()    [核心：批量移动]

依赖关系：
- 依赖：selectedNoteIds（在MainActivity中）
- 被调用：onOptionsItemSelected(), loadMoments()（getView中）
- 调用核心：loadMoments()（移动后刷新）
```

### 8. 设置模块（完全独立）
```
showSettingsDialog()
loadSettings()

依赖关系：
- 依赖：dbHelper（存储设置）
- 被调用：onCreate(), onOptionsItemSelected()
- 影响：showCost, timeDescOrder等状态变量
```

---

## 三、依赖关系图

```
MainActivity (3240行)
│
├── [核心主干] 笔记CRUD (约800行)
│   ├── saveMoment()
│   ├── loadMoments()
│   ├── deleteNote()
│   ├── getNoteContentById()
│   ├── updateListItemWithExtras()
│   └── updateSingleNoteView()
│
├── [叶分支1] 导入导出 (约600行) ⭐ 完全独立
│   ├── showExportDialog()
│   ├── exportData()
│   ├── writeCsvData()
│   ├── writeJsonData()
│   ├── showImportDialog()
│   ├── importData()
│   ├── readCsvData()
│   └── readJsonData()
│
├── [叶分支2] 项目管理 (约400行) ⭐ 相对独立
│   ├── showProjectMenu()
│   ├── showProjectManagementDialog()
│   ├── showCreateProjectDialog()
│   ├── switchProject()          [调用核心：loadMoments()]
│   └── 各种对话框...
│
├── [叶分支3] 回收站 (约120行) ⭐ 完全独立
│   ├── showRecycleBinDialog()
│   └── 各种确认对话框...
│
├── [叶分支4] 标签管理 (约200行) ⚠️ 半独立
│   ├── showTagSelectionDialog()
│   ├── addTagChip()
│   └── addTagsInfo()
│   └── 状态：selectedTags
│
├── [叶分支5] 时间范围 (约150行) ⚠️ 半独立
│   ├── initTimeDialogs()
│   ├── showTimePicker()
│   └── addTimeRangeInfo()
│   └── 状态：hasTimeRange, startCalendar, endCalendar
│
├── [叶分支6] 折叠功能 (约150行) ⚠️ 半独立
│   ├── loadFoldedNoteIds()
│   ├── saveFoldedNoteIds()
│   ├── toggleNoteFold()
│   └── checkAndShowFoldButton()
│   └── 状态：foldedNoteIds
│
├── [叶分支7] 多选模式 (约200行) ⚠️ 相对独立
│   ├── toggleMultiSelectMode()
│   ├── exitMultiSelectMode()
│   ├── showMoveToProjectDialog()
│   └── moveNotesToProject()
│   └── 状态：selectedNoteIds, isMultiSelectMode
│
├── [叶分支8] 设置 (约150行) ⭐ 完全独立
│   ├── showSettingsDialog()
│   └── loadSettings()
│
└── [基础设施] 生命周期和路由 (约200行)
    ├── onCreate()
    ├── onResume()
    ├── onDestroy()
    ├── onOptionsItemSelected()
    └── onActivityResult()
```

---

## 四、拆分优先级建议

### 第一优先级：完全独立的叶分支（最容易拆分）
1. **导入导出模块** (约600行)
   - 完全独立，只依赖dbHelper和projectManager
   - 拆分后：`ImportExportManager` 或 `ImportExportHandler`

2. **回收站模块** (约120行)
   - 完全独立，只依赖projectManager
   - 拆分后：`RecycleBinManager`

3. **设置模块** (约150行)
   - 完全独立，只依赖dbHelper
   - 拆分后：`SettingsManager`

### 第二优先级：相对独立的叶分支（需要处理状态）
4. **项目管理模块** (约400行)
   - 相对独立，但会调用核心的loadMoments()
   - 拆分后：`ProjectUIManager`

5. **多选模式模块** (约200行)
   - 相对独立，但状态在MainActivity中
   - 拆分后：`MultiSelectManager`

### 第三优先级：半独立的叶分支（需要重构状态管理）
6. **标签管理模块** (约200行)
   - 状态selectedTags在MainActivity中
   - 拆分后：`TagManager`（需要将状态移到Manager）

7. **时间范围模块** (约150行)
   - 状态hasTimeRange, startCalendar, endCalendar在MainActivity中
   - 拆分后：`TimeRangeManager`（需要将状态移到Manager）

8. **折叠功能模块** (约150行)
   - 状态foldedNoteIds在MainActivity中
   - 拆分后：`FoldManager`（需要将状态移到Manager）

### 第四优先级：核心主干（最后拆分）
9. **笔记CRUD核心** (约800行)
   - 这是核心功能，其他模块都依赖它
   - 拆分后：`NoteManager` 或 `NoteController`

---

## 五、拆分策略

### 策略1：从外到内（推荐）
1. 先拆分完全独立的叶分支（导入导出、回收站、设置）
2. 再拆分相对独立的叶分支（项目管理、多选模式）
3. 最后拆分半独立的叶分支（标签、时间范围、折叠）
4. 最后重构核心主干

### 策略2：按依赖深度
- 深度0（无依赖）：导入导出、回收站、设置
- 深度1（依赖核心）：项目管理、多选模式
- 深度2（依赖核心+状态）：标签、时间范围、折叠
- 深度3（核心本身）：笔记CRUD

---

## 六、拆分后的预期效果

### 拆分前：
- MainActivity: 3240行

### 拆分后（按优先级1-3）：
- MainActivity: ~1500行（核心+基础设施）
- ImportExportManager: ~600行
- RecycleBinManager: ~120行
- SettingsManager: ~150行
- ProjectUIManager: ~400行
- MultiSelectManager: ~200行
- TagManager: ~200行
- TimeRangeManager: ~150行
- FoldManager: ~150行

**总计：~3470行**（拆分本身会增加一些代码，但结构更清晰）

---

## 七、关键发现

1. **核心主干很小**：真正的核心功能（笔记CRUD）只有约800行
2. **叶分支很大**：8个叶分支共约2000行，占62%
3. **完全独立的模块**：导入导出、回收站、设置，共约870行，占27%
4. **状态管理是难点**：标签、时间范围、折叠功能的状态都在MainActivity中

### 建议：
1. **先拆分完全独立的模块**（导入导出、回收站、设置），可以立即减少约870行
2. **状态管理统一处理**：考虑创建一个StateManager来管理所有状态
3. **核心功能最后拆分**：核心功能是其他模块的依赖，最后拆分更安全

