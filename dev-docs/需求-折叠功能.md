查看数据库结构，制定分步执行方案：


已查看数据库结构。下面是分步执行方案：

不需要备份。原因：
1. 使用现有的 `settings` 表存储配置（不新增表）
2. 折叠状态用 SharedPreferences（不涉及数据库）
3. 不修改现有表结构，只添加新的配置项

## 分步骤执行方案

### 第一阶段：基础功能（字数计算和显示）

#### 步骤1：添加字数计算工具方法
- 位置：`uitl/StringUtil.java`
- 功能：实现中英文混合字数统计
  - 中文：每个字符算1字
  - 英文：按单词统计（空格分隔）
  - 包含换行符和空格
- 方法名：`calculateWordCount(String text)`

#### 步骤2：添加折叠配置到数据库
- 位置：`NoteDbHelper.java`
- 操作：
  - 添加常量：`KEY_FOLD_DISPLAY_LENGTH = "fold_display_length"`
  - 在 `onCreate` 中添加默认值 300
  - 在 `onUpgrade` 中处理升级（如果版本升级）

#### 步骤3：在列表项中判断是否显示折叠按钮
- 位置：`MainActivity.java` 的 `updateListItemWithExtras` 或 `getView`
- 功能：
  - 读取当前项目的折叠字数配置
  - 计算笔记字数
  - 如果超过配置值，显示折叠按钮（暂时只显示，不实现功能）

---

### 第二阶段：折叠状态管理

#### 步骤4：添加折叠状态存储（SharedPreferences）
- 位置：`MainActivity.java`
- 功能：
  - 添加成员变量：`Set<Long> foldedNoteIds`
  - 添加方法：`loadFoldedNoteIds()` - 从 SharedPreferences 加载
  - 添加方法：`saveFoldedNoteIds()` - 保存到 SharedPreferences
  - 添加方法：`toggleNoteFold(long noteId)` - 切换折叠状态
- SharedPreferences Key：`folded_note_ids_{项目名}`

#### 步骤5：在项目切换时加载折叠状态
- 位置：`MainActivity.java` 的 `switchProject` 方法
- 功能：切换项目时调用 `loadFoldedNoteIds()`

---

### 第三阶段：UI 实现

#### 步骤6：实现折叠/展开按钮 UI
- 位置：`MainActivity.java` 的 `getView` 或 `updateListItemWithExtras`
- 功能：
  - 在内容文本后添加"展开"/"折叠"按钮
  - 按钮样式：加粗、黑色、可点击
  - 根据折叠状态显示不同文本

#### 步骤7：实现内容截断显示
- 位置：`MainActivity.java`
- 功能：
  - 如果笔记被折叠：显示前 N 字 + "..."
  - 如果笔记展开：显示完整内容
  - 截断时注意不要截断单词（英文）

#### 步骤8：实现按钮点击事件
- 位置：`MainActivity.java`
- 功能：
  - 点击"折叠"：保存状态，刷新列表
  - 点击"展开"：移除状态，刷新列表

---

### 第四阶段：配置功能

#### 步骤9：在设置对话框中添加折叠字数配置
- 位置：`MainActivity.java` 的 `showSettingsDialog`
- 功能：
  - 添加输入框或滑块设置折叠显示字数
  - 保存到数据库
  - 默认值 300

---

### 第五阶段：优化和测试

#### 步骤10：优化性能
- 缓存折叠状态到内存
- 避免重复计算字数

#### 步骤11：测试
- 测试切换项目时折叠状态保持
- 测试跨会话保持
- 测试字数计算准确性

---

## 建议的执行顺序

建议按以下顺序逐步实现和测试：

1. 先做步骤1（字数计算）→ 测试
2. 再做步骤2（配置存储）→ 测试
3. 然后步骤4（状态管理）→ 测试
4. 接着步骤6-8（UI和功能）→ 测试
5. 最后步骤9（配置界面）→ 测试

每一步完成后测试，确保没问题再继续。
