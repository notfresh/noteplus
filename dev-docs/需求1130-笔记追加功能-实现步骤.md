# 笔记追加功能 - 分步实现计划

## 需求确认总结

### 数据库设计
- ✅ `parent_comment_id` 字段：支持嵌套回复（NULL表示直接回复笔记，非NULL表示回复某个评论）
- ✅ 不需要 `root_note_id` 字段
- ✅ 编号按笔记独立，从1开始（可存储，也可计算）

### 显示逻辑
- ✅ 默认展开，显示前3条（包括回复）
- ✅ 超过3条时显示展开/折叠按钮
- ✅ 回复不缩进，平级显示
- ✅ 显示格式：`25/11/30 15:20 @1 追加内容` 或 `25/11/30 15:20 追加@1 回复内容`

### 交互方式
- ✅ 有专门的"添加追加"按钮
- ✅ 可以针对笔记添加，也可以针对评论添加

---

## 实现步骤拆解

### 阶段1：数据库基础（必须，先做）

#### 步骤1.1：修复数据库表结构
**目标**：创建正确的数据库表，支持嵌套回复

**任务清单**：
- [ ] 修复SQL：`parent_comment_id` 允许NULL（直接回复笔记时）
- [ ] 修复索引：使用 `note_id` 而不是 `root_note_id`
- [ ] 添加外键约束：`parent_comment_id` 引用 `comment_id`
- [ ] 更新数据库版本号（从5升级到6）

**预计代码量**：约30行
**预计时间**：15分钟

**关键代码**：
```sql
CREATE TABLE note_comments (
    comment_id INTEGER PRIMARY KEY AUTOINCREMENT,
    note_id INTEGER NOT NULL,
    parent_comment_id INTEGER DEFAULT NULL,  -- 允许NULL
    content TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    cost REAL DEFAULT 0,
    FOREIGN KEY (note_id) REFERENCES notes(_id) ON DELETE CASCADE,
    FOREIGN KEY (parent_comment_id) REFERENCES note_comments(comment_id) ON DELETE CASCADE
);

CREATE INDEX idx_note_comments_note_id ON note_comments(note_id);
CREATE INDEX idx_note_comments_timestamp ON note_comments(timestamp);
```

---

#### 步骤1.2：添加数据库常量和方法
**目标**：在 `NoteDbHelper` 中添加必要的常量和方法

**任务清单**：
- [ ] 添加表常量定义
- [ ] 添加 `addComment(noteId, parentCommentId, content, cost)` 方法
- [ ] 添加 `getCommentsForNote(noteId)` 方法（按时间正序）
- [ ] 添加 `getCommentCount(noteId)` 方法
- [ ] 添加 `deleteComment(commentId)` 方法
- [ ] 添加 `getNextCommentNumber(noteId)` 方法（计算下一个编号）

**预计代码量**：约150行
**预计时间**：30分钟

**关键方法签名**：
```java
// 添加评论（parentCommentId为null表示直接回复笔记）
public long addComment(long noteId, Long parentCommentId, String content, double cost)

// 获取笔记的所有评论（包括回复）
public Cursor getCommentsForNote(long noteId)

// 获取评论数量
public int getCommentCount(long noteId)

// 获取下一个评论编号（用于显示）
public int getNextCommentNumber(long noteId)
```

---

### 阶段2：基础UI显示（核心功能）

#### 步骤2.1：在列表项中显示追加内容数量
**目标**：在笔记列表项中显示"💬 追加内容 (N条)"

**任务清单**：
- [ ] 在 `updateListItemWithExtras()` 中调用 `addCommentsInfo()`
- [ ] 创建 `addCommentsInfo()` 方法
- [ ] 显示追加内容数量（如果为0则不显示）
- [ ] 创建追加内容容器（浅灰色背景）

**预计代码量**：约50行
**预计时间**：20分钟

**关键逻辑**：
```java
private void addCommentsInfo(LinearLayout container, long noteId) {
    int commentCount = dbHelper.getCommentCount(noteId);
    if (commentCount > 0) {
        // 创建容器，显示"💬 追加内容 (N条)"
    }
}
```

---

#### 步骤2.2：显示前3条追加内容（默认展开）
**目标**：默认展开显示前3条追加内容

**任务清单**：
- [ ] 创建 `displayComments()` 方法
- [ ] 查询数据库获取评论列表
- [ ] 只显示前3条（如果总数<=3则全部显示）
- [ ] 格式化显示：`25/11/30 15:20 @1 内容` 或 `25/11/30 15:20 追加@1 内容`
- [ ] 计算并显示编号（@1, @2, @3...）

**预计代码量**：约100行
**预计时间**：40分钟

**关键逻辑**：
```java
private void displayComments(LinearLayout container, long noteId, int maxDisplay) {
    Cursor cursor = dbHelper.getCommentsForNote(noteId);
    int count = 0;
    int commentNumber = 1; // 编号从1开始
    
    while (cursor.moveToNext() && count < maxDisplay) {
        Long parentId = cursor.getLong(...); // 可能为null
        String displayText;
        
        if (parentId == null) {
            // 直接回复笔记：@1 内容
            displayText = formatTimestamp(timestamp) + " @{commentNumber} " + content;
            commentNumber++;
        } else {
            // 回复评论：追加@父编号 内容
            int parentNumber = getCommentNumber(parentId);
            displayText = formatTimestamp(timestamp) + " 追加@" + parentNumber + " " + content;
        }
        
        // 创建TextView显示
        count++;
    }
}
```

---

#### 步骤2.3：添加"添加追加"按钮
**目标**：在每条评论后和底部添加"添加追加"按钮

**任务清单**：
- [ ] 在每条评论项后添加"添加追加"按钮（用于回复该评论）
- [ ] 在 `displayComments()` 末尾添加按钮（用于直接回复笔记）
- [ ] 评论后的按钮点击后调用 `showAddCommentDialog(noteId, commentId)`
- [ ] 底部按钮点击后调用 `showAddCommentDialog(noteId, null)`
- [ ] 按钮样式统一

**预计代码量**：约40行
**预计时间**：15分钟

---

### 阶段3：添加追加内容功能

#### 步骤3.1：创建添加追加内容对话框（针对笔记）
**目标**：实现针对笔记的添加追加内容功能

**任务清单**：
- [ ] 创建 `showAddCommentDialog(long noteId, Long parentCommentId)` 方法
- [ ] 创建输入对话框（内容 + 可选花费）
- [ ] 保存时调用 `dbHelper.addComment(noteId, null, content, cost)`
- [ ] 保存成功后刷新笔记视图
- [ ] 在笔记操作菜单中添加"添加追加"选项

**预计代码量**：约80行
**预计时间**：30分钟

**关键逻辑**：
```java
private void showAddCommentDialog(long noteId, Long parentCommentId) {
    // parentCommentId为null表示直接回复笔记
    // 创建输入对话框
    // 保存时：dbHelper.addComment(noteId, parentCommentId, content, cost)
    // 刷新视图
}
```

---

#### 步骤3.2：实现编号计算逻辑
**目标**：正确计算和显示评论编号

**任务清单**：
- [ ] 实现 `getCommentNumber(long commentId)` 方法（根据commentId查找编号）
- [ ] 在显示评论时正确显示编号
- [ ] 处理回复的编号显示（追加@父编号）

**预计代码量**：约50行
**预计时间**：20分钟

**关键逻辑**：
- 直接回复笔记的评论：按时间顺序编号 @1, @2, @3...
- 回复评论的评论：显示为 `追加@父编号`

---

### 阶段4：展开/折叠功能

#### 步骤4.1：实现展开/折叠逻辑
**目标**：超过3条时显示展开/折叠按钮

**任务清单**：
- [ ] 修改 `addCommentsInfo()`：判断总数是否>3
- [ ] 如果>3，默认只显示前3条
- [ ] 添加展开/折叠按钮或点击标题展开
- [ ] 实现 `toggleCommentsExpanded()` 方法
- [ ] 使用 `Set<Long> expandedComments` 存储展开状态

**预计代码量**：约80行
**预计时间**：30分钟

**关键逻辑**：
```java
private void addCommentsInfo(LinearLayout container, long noteId) {
    int totalCount = dbHelper.getCommentCount(noteId);
    if (totalCount > 0) {
        // 创建容器
        // 显示标题"💬 追加内容 (N条)"
        
        if (totalCount > 3) {
            // 显示展开/折叠按钮
            // 默认只显示前3条
            if (expandedComments.contains(noteId)) {
                displayComments(container, noteId, Integer.MAX_VALUE); // 显示全部
            } else {
                displayComments(container, noteId, 3); // 只显示3条
            }
        } else {
            // 总数<=3，直接显示全部
            displayComments(container, noteId, Integer.MAX_VALUE);
        }
    }
}
```

---

### 阶段5：回复功能（已合并到步骤2.3）

**注意**：回复功能已合并到步骤2.3，每条评论后都有"添加追加"按钮

#### 步骤5.1：优化回复显示格式
**目标**：正确显示回复的格式（追加@编号）

**任务清单**：
- [ ] 在显示评论时，判断是否有 `parent_comment_id`
- [ ] 如果有，查找父评论的编号
- [ ] 显示格式：`时间 追加@父编号 内容`

**预计代码量**：约40行
**预计时间**：15分钟

---

### 阶段6：删除和优化

#### 步骤6.1：删除追加内容功能（长按删除）
**目标**：支持长按删除追加内容

**任务清单**：
- [ ] 在评论项上添加长按监听器
- [ ] 长按后弹出删除确认对话框
- [ ] 创建 `showDeleteCommentDialog()` 方法
- [ ] 调用 `dbHelper.deleteComment(commentId)`
- [ ] 删除后刷新视图

**预计代码量**：约50行
**预计时间**：20分钟

**关键逻辑**：
```java
// 在每条评论项上添加长按监听
commentItem.setOnLongClickListener(v -> {
    showDeleteCommentDialog(commentId, noteId);
    return true;
});
```

---

#### 步骤6.2：刷新视图优化
**目标**：添加/删除后正确刷新笔记视图

**任务清单**：
- [ ] 实现 `refreshNoteView(long noteId)` 方法
- [ ] 找到笔记在列表中的位置
- [ ] 只刷新该笔记的视图，不刷新整个列表
- [ ] 添加追加内容后自动展开（如果之前是折叠的）

**预计代码量**：约50行
**预计时间**：20分钟

---

#### 步骤6.3：时间格式优化
**目标**：使用新的时间格式 `25/11/30 15:20`

**任务清单**：
- [ ] 创建新的时间格式化方法 `formatCommentTimestamp(long timestamp)`
- [ ] 格式：`yy/MM/dd HH:mm`
- [ ] 在显示评论时使用新格式

**预计代码量**：约20行
**预计时间**：10分钟

---

### 阶段7：数据一致性（重要）

#### 步骤7.1：移动笔记时一并移动评论
**目标**：在 `moveNotesToProject()` 中处理评论

**任务清单**：
- [ ] 在移动笔记时，查询该笔记的所有评论
- [ ] 将评论也插入到目标项目的数据库
- [ ] 保持评论的层级关系（parent_comment_id）

**预计代码量**：约60行
**预计时间**：25分钟

**关键逻辑**：
```java
// 在 moveNotesToProject() 中
// 1. 复制笔记后，获取新笔记ID
// 2. 查询原笔记的所有评论
// 3. 创建评论ID映射（旧ID -> 新ID）
// 4. 递归复制评论，更新parent_comment_id
```

---

### 阶段8：导入导出支持（可选）

#### 步骤8.1：导出时包含评论
**目标**：导出JSON/CSV时包含追加内容

**任务清单**：
- [ ] 在 `writeJsonData()` 中添加评论导出
- [ ] 在 `writeCsvData()` 中添加评论导出
- [ ] 保持评论的层级关系

**预计代码量**：约80行
**预计时间**：30分钟

---

#### 步骤8.2：导入时恢复评论
**目标**：导入时恢复追加内容

**任务清单**：
- [ ] 在 `readJsonData()` 中解析评论
- [ ] 在 `readCsvData()` 中解析评论
- [ ] 恢复评论的层级关系

**预计代码量**：约80行
**预计时间**：30分钟

---

## 实现顺序建议

### 第一周：核心功能
1. ✅ 步骤1.1：修复数据库表结构
2. ✅ 步骤1.2：添加数据库常量和方法
3. ✅ 步骤2.1：显示追加内容数量
4. ✅ 步骤2.2：显示前3条追加内容
5. ✅ 步骤2.3：添加"添加追加"按钮
6. ✅ 步骤3.1：创建添加追加内容对话框

### 第二周：完整功能
7. ✅ 步骤3.2：实现编号计算逻辑
8. ✅ 步骤4.1：实现展开/折叠功能
9. ✅ 步骤5.1：优化回复显示格式
10. ✅ 步骤6.1：删除追加内容功能（长按删除）
11. ✅ 步骤6.2：刷新视图优化

### 第三周：优化和扩展
13. ✅ 步骤6.3：时间格式优化
14. ✅ 步骤7.1：移动笔记时一并移动评论
15. ⚠️ 步骤8.1：导出时包含评论（可选）
16. ⚠️ 步骤8.2：导入时恢复评论（可选）

---

## 代码量估算

| 阶段 | 步骤 | 代码量 | 时间 |
|------|------|--------|------|
| 阶段1 | 1.1 + 1.2 | ~180行 | 45分钟 |
| 阶段2 | 2.1 + 2.2 + 2.3 | ~190行 | 75分钟 |
| 阶段3 | 3.1 + 3.2 | ~130行 | 50分钟 |
| 阶段4 | 4.1 | ~80行 | 30分钟 |
| 阶段5 | 5.1 | ~40行 | 15分钟 |
| 阶段6 | 6.1 + 6.2 + 6.3 | ~120行 | 50分钟 |
| 阶段7 | 7.1 | ~60行 | 25分钟 |
| 阶段8 | 8.1 + 8.2 | ~160行 | 60分钟 |
| **总计** | | **~970行** | **~5.5小时** |

---

## 注意事项

1. **数据库升级**：确保 `onUpgrade()` 正确处理版本升级
2. **编号计算**：编号可以存储，也可以实时计算（建议存储，性能更好）
3. **性能优化**：评论多时，考虑只查询前N条
4. **UI刷新**：添加/删除后只刷新单个笔记视图，不要刷新整个列表

---

## 测试要点

### 基础功能测试
- [ ] 添加追加内容（针对笔记）
- [ ] 显示追加内容（前3条）
- [ ] 展开/折叠功能
- [ ] 删除追加内容

### 回复功能测试
- [ ] 回复笔记（直接追加）
- [ ] 回复评论（嵌套回复）
- [ ] 编号显示正确（@1, @2, 追加@1等）

### 数据一致性测试
- [ ] 删除笔记时，评论一并删除
- [ ] 移动笔记时，评论一并移动
- [ ] 评论的层级关系正确

### 边界情况测试
- [ ] 笔记没有评论时的显示
- [ ] 评论数量正好3条时的显示
- [ ] 评论数量超过3条时的展开/折叠
- [ ] 删除评论后编号是否正确

已知限制
未完成的功能
移动笔记时，评论不会一起移动
如果移动笔记到其他项目，评论会丢失
建议：暂时不要移动有评论的笔记
导入导出可能不包含评论
导出时可能不包含评论数据
导入时可能不恢复评论

测试建议
先测试基础功能
添加、显示、删除评论
测试嵌套回复
回复评论，再回复回复
测试边界情况
没有评论、3条评论、超过3条评论
可以开始测试。如发现问题，告诉我，我会修复。