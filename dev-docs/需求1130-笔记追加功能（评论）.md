# éœ€æ±‚ï¼šç¬”è®°è¿½åŠ åŠŸèƒ½ï¼ˆç±»ä¼¼è¯„è®ºï¼‰

## ä¸€ã€éœ€æ±‚åˆ†æ

### åŠŸèƒ½æè¿°
- å¯¹å·²æœ‰ç¬”è®°å¯ä»¥è¿½åŠ åç»­å†…å®¹ï¼ˆç±»ä¼¼è¯„è®º/å›å¤ï¼‰
- è¿½åŠ å†…å®¹ä¸åŸå§‹ç¬”è®°å…³è”ï¼Œå½¢æˆå¯¹è¯é“¾
- æ¯æ¡è¿½åŠ å†…å®¹éƒ½æœ‰ç‹¬ç«‹çš„æ—¶é—´æˆ³
- å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„å¯¹è¯å†å²
- æ”¯æŒå›å¤è¿½åŠ å†…å®¹ï¼ˆåµŒå¥—è¯„è®ºï¼Œç»™æ¯ä¸ªè¯„è®ºç¼–ä¸ªå· 1ï¼‰

### ä½¿ç”¨åœºæ™¯
1. è®°å½•åç»­è¿›å±•ï¼šåŸå§‹ç¬”è®°è®°å½•äº†ä¸€ä¸ªäº‹ä»¶ï¼Œåç»­å¯ä»¥è¿½åŠ æ›´æ–°
2. è¡¥å……ä¿¡æ¯ï¼šå¯¹åŸå§‹ç¬”è®°è¿›è¡Œè¡¥å……è¯´æ˜
3. å¯¹è¯å¼è®°å½•ï¼šç±»ä¼¼èŠå¤©è®°å½•ï¼Œå¯ä»¥æŒç»­è¿½åŠ å†…å®¹

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 æ–°å¢è¡¨ç»“æ„

```sql
CREATE TABLE note_comments (
    comment_id INTEGER PRIMARY KEY AUTOINCREMENT,
    note_id INTEGER NOT NULL,                    -- å…³è”çš„åŸå§‹ç¬”è®°ID
    parent_comment_id INTEGER DEFAULT NULL,      -- çˆ¶è¯„è®ºIDï¼ˆNULLè¡¨ç¤ºç›´æ¥å›å¤ç¬”è®°ï¼ŒéNULLè¡¨ç¤ºå›å¤æŸä¸ªè¯„è®ºï¼‰
    content TEXT NOT NULL,                       -- è¿½åŠ å†…å®¹
    timestamp INTEGER NOT NULL,                  -- è¿½åŠ æ—¶é—´
    cost REAL DEFAULT 0,                         -- å¯é€‰ï¼šè¿½åŠ æ—¶çš„èŠ±è´¹ï¼ˆç»§æ‰¿ç¬”è®°çš„èŠ±è´¹å­—æ®µï¼‰
    FOREIGN KEY (note_id) REFERENCES notes(_id) ON DELETE CASCADE,
    FOREIGN KEY (parent_comment_id) REFERENCES note_comments(comment_id) ON DELETE CASCADE
);
```

### 2.2 å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| comment_id | INTEGER | ä¸»é”®ï¼Œè¿½åŠ å†…å®¹ID |
| parent_comment_id | INTEGER | å¤–é”®ï¼Œå…³è”çˆ¶è¯„è®ºID |
| note_id | INTEGER | å¤–é”®ï¼Œå…³è”çš„åŸå§‹ç¬”è®°ID |
| content | TEXT | è¿½åŠ å†…å®¹æ–‡æœ¬ |
| timestamp | INTEGER | è¿½åŠ æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |
| cost | REAL | å¯é€‰ï¼šè¿½åŠ æ—¶çš„èŠ±è´¹é‡‘é¢ |

### 2.3 ç´¢å¼•è®¾è®¡

```sql
CREATE INDEX idx_note_comments_note_id ON note_comments(note_id);
CREATE INDEX idx_note_comments_timestamp ON note_comments(timestamp);
```

---

## ä¸‰ã€UIè®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨åˆ—è¡¨é¡¹ä¸­å±•å¼€æ˜¾ç¤ºï¼ˆæ¨èï¼‰ï¼ˆé€‰ä¸­ï¼‰

#### 3.1 æ˜¾ç¤ºæ•ˆæœ

é»˜è®¤å±•å¼€ï¼Œæœ€å¤šæ˜¾ç¤ºä¸‰æ¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2024å¹´01æœˆ15æ—¥ï¼Œæ˜ŸæœŸä¸€ï¼Œ14:30    â”‚
â”‚ åŸå§‹ç¬”è®°å†…å®¹...                  â”‚
â”‚ [æ—¶é—´åŒºé—´] [æ ‡ç­¾]                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’¬ è¿½åŠ å†…å®¹ (2æ¡)            â”‚ â”‚ â† å…¨éƒ¨æŠ˜å æ—¶ï¼šå¯ç‚¹å‡»å±•å¼€
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡»å±•å¼€åï¼š 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2024å¹´01æœˆ15æ—¥ï¼Œæ˜ŸæœŸä¸€ï¼Œ14:30    â”‚
â”‚ åŸå§‹ç¬”è®°å†…å®¹...                  â”‚
â”‚ [æ—¶é—´åŒºé—´] [æ ‡ç­¾]                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’¬ è¿½åŠ å†…å®¹ (3æ¡)            â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚ 25/11/30 15:20 @1 è¿½åŠ å†…å®¹1... [æ·»åŠ è¿½åŠ ] â”‚ â”‚
â”‚ â”‚ 25/11/30 16:30 @2 è¿½åŠ å†…å®¹2... [æ·»åŠ è¿½åŠ ] â”‚ â”‚
â”‚ â”‚ 25/11/30 15:25 @3 è¿½åŠ @1 è¿½åŠ å†…å®¹3... [æ·»åŠ è¿½åŠ ] â”‚ â”‚
â”‚ â”‚ 25/11/30 15:25 @4 è¿½åŠ @3 è¿½åŠ å†…å®¹4... [æ·»åŠ è¿½åŠ ] â”‚ â”‚
â”‚ â”‚ [æ·»åŠ è¿½åŠ ]                  â”‚ â”‚ â† é’ˆå¯¹ç¬”è®°æœ¬èº«çš„è¿½åŠ 
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 äº¤äº’æµç¨‹
1. åˆ—è¡¨é¡¹é»˜è®¤æ˜¾ç¤ºè¿½åŠ å†…å®¹ï¼Œé»˜è®¤åªæ˜¾ç¤ºæœ€å¤šä¸‰æ¡ï¼Œå…¶ä½™çš„æŠ˜å 
2. å¦‚æœè¶…è¿‡3æ¡ï¼Œåœ¨"è¿½åŠ å†…å®¹"åŒºåŸŸ æ˜¾ç¤ºå±•å¼€/æŠ˜å 
3. å±•å¼€åæ˜¾ç¤ºæ‰€æœ‰è¿½åŠ å†…å®¹ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
4. **æ¯æ¡è¯„è®ºåéƒ½æœ‰"æ·»åŠ è¿½åŠ "æŒ‰é’®**ï¼ˆç”¨äºå›å¤è¯¥è¯„è®ºï¼‰
5. åº•éƒ¨æœ‰"æ·»åŠ è¿½åŠ "æŒ‰é’®ï¼ˆç”¨äºç›´æ¥å›å¤ç¬”è®°ï¼‰
6. ç‚¹å‡»"æ·»åŠ è¿½åŠ "å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†
7. **é•¿æŒ‰è¯„è®ºé¡¹å¼¹å‡ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†**

### æ–¹æ¡ˆ2ï¼šåœ¨ç¬”è®°è¯¦æƒ…é¡µæ˜¾ç¤ºï¼ˆå¤‡é€‰ï¼‰ï¼ˆæ”¾å¼ƒï¼ï¼‰

#### 2.1 æ˜¾ç¤ºæ•ˆæœ
- é•¿æŒ‰ç¬”è®° â†’ æ˜¾ç¤ºæ“ä½œèœå• â†’ é€‰æ‹©"æŸ¥çœ‹è¯¦æƒ…"
- æ‰“å¼€è¯¦æƒ…é¡µï¼Œæ˜¾ç¤ºåŸå§‹ç¬”è®°å’Œæ‰€æœ‰è¿½åŠ å†…å®¹
- è¯¦æƒ…é¡µåº•éƒ¨æœ‰è¾“å…¥æ¡†ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ è¿½åŠ å†…å®¹

#### 2.2 ä¼˜ç¼ºç‚¹
- âœ… æ˜¾ç¤ºç©ºé—´å¤§ï¼Œä½“éªŒå¥½
- âŒ éœ€è¦æ–°å»ºActivity/Fragmentï¼Œå®ç°å¤æ‚
- âŒ ä¸ç¬¦åˆå½“å‰çš„å•é¡µåº”ç”¨è®¾è®¡

---

## å››ã€è¯¦ç»†å®ç°è®¾è®¡

### 4.1 æ•°æ®åº“å±‚ï¼ˆNoteDbHelperï¼‰

#### 4.1.1 è¡¨å¸¸é‡å®šä¹‰

```java
public static final String TABLE_NOTE_COMMENTS = "note_comments";
public static final String COLUMN_COMMENT_ID = "comment_id";
public static final String COLUMN_PARENT_COMMENT_ID = "parent_comment_id";
public static final String COLUMN_COMMENT_NOTE_ID = "note_id";
public static final String COLUMN_COMMENT_CONTENT = "content";
public static final String COLUMN_COMMENT_TIMESTAMP = "timestamp";
public static final String COLUMN_COMMENT_COST = "cost";
```

#### 4.1.2 æ•°æ®åº“å‡çº§ï¼ˆonUpgradeï¼‰

```java
@Override
public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    if (oldVersion < 6) {
        // åˆ›å»ºè¿½åŠ å†…å®¹è¡¨
        String CREATE_NOTE_COMMENTS_TABLE = "CREATE TABLE " + TABLE_NOTE_COMMENTS + "("
                + COLUMN_COMMENT_ID + " INTEGER PRIMARY KEY AUTOINCREMENT,"
                + COLUMN_COMMENT_NOTE_ID + " INTEGER NOT NULL,"
                + COLUMN_COMMENT_CONTENT + " TEXT NOT NULL,"
                + COLUMN_COMMENT_TIMESTAMP + " INTEGER NOT NULL,"
                + COLUMN_COMMENT_COST + " REAL DEFAULT 0,"
                + "FOREIGN KEY (" + COLUMN_COMMENT_NOTE_ID + ") REFERENCES " 
                + TABLE_NOTES + "(" + COLUMN_ID + ") ON DELETE CASCADE"
                + ")";
        
        db.execSQL(CREATE_NOTE_COMMENTS_TABLE);
        
        // åˆ›å»ºç´¢å¼•
        db.execSQL("CREATE INDEX idx_note_comments_note_id ON " 
                + TABLE_NOTE_COMMENTS + "(" + COLUMN_COMMENT_NOTE_ID + ")");
        db.execSQL("CREATE INDEX idx_note_comments_timestamp ON " 
                + TABLE_NOTE_COMMENTS + "(" + COLUMN_COMMENT_TIMESTAMP + ")");
    }
}
```

#### 4.1.3 æ–°å¢æ–¹æ³•

```java
/**
 * æ·»åŠ è¿½åŠ å†…å®¹
 * @param noteId åŸå§‹ç¬”è®°ID
 * @param content è¿½åŠ å†…å®¹
 * @param cost èŠ±è´¹é‡‘é¢ï¼ˆå¯é€‰ï¼‰
 * @return è¿½åŠ å†…å®¹IDï¼Œå¤±è´¥è¿”å›-1
 */
public long addComment(long noteId, String content, double cost) {
    SQLiteDatabase db = this.getWritableDatabase();
    ContentValues values = new ContentValues();
    values.put(COLUMN_COMMENT_NOTE_ID, noteId);
    values.put(COLUMN_COMMENT_CONTENT, content);
    values.put(COLUMN_COMMENT_TIMESTAMP, System.currentTimeMillis());
    values.put(COLUMN_COMMENT_COST, cost);
    
    return db.insert(TABLE_NOTE_COMMENTS, null, values);
}

/**
 * è·å–ç¬”è®°çš„æ‰€æœ‰è¿½åŠ å†…å®¹ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
 * @param noteId ç¬”è®°ID
 * @return Cursor
 */
public Cursor getCommentsForNote(long noteId) {
    SQLiteDatabase db = this.getReadableDatabase();
    return db.query(
        TABLE_NOTE_COMMENTS,
        new String[]{
            COLUMN_COMMENT_ID,
            COLUMN_COMMENT_CONTENT,
            COLUMN_COMMENT_TIMESTAMP,
            COLUMN_COMMENT_COST
        },
        COLUMN_COMMENT_NOTE_ID + " = ?",
        new String[]{String.valueOf(noteId)},
        null, null,
        COLUMN_COMMENT_TIMESTAMP + " ASC"  // æŒ‰æ—¶é—´æ­£åº
    );
}

/**
 * è·å–ç¬”è®°çš„è¿½åŠ å†…å®¹æ•°é‡
 * @param noteId ç¬”è®°ID
 * @return æ•°é‡
 */
public int getCommentCount(long noteId) {
    SQLiteDatabase db = this.getReadableDatabase();
    Cursor cursor = db.query(
        TABLE_NOTE_COMMENTS,
        new String[]{"COUNT(*) as count"},
        COLUMN_COMMENT_NOTE_ID + " = ?",
        new String[]{String.valueOf(noteId)},
        null, null, null
    );
    
    int count = 0;
    if (cursor != null && cursor.moveToFirst()) {
        count = cursor.getInt(0);
        cursor.close();
    }
    return count;
}

/**
 * åˆ é™¤è¿½åŠ å†…å®¹
 * @param commentId è¿½åŠ å†…å®¹ID
 * @return åˆ é™¤çš„è¡Œæ•°
 */
public int deleteComment(long commentId) {
    SQLiteDatabase db = this.getWritableDatabase();
    return db.delete(
        TABLE_NOTE_COMMENTS,
        COLUMN_COMMENT_ID + " = ?",
        new String[]{String.valueOf(commentId)}
    );
}

/**
 * æ›´æ–°è¿½åŠ å†…å®¹
 * @param commentId è¿½åŠ å†…å®¹ID
 * @param content æ–°å†…å®¹
 * @return æ›´æ–°çš„è¡Œæ•°
 */
public int updateComment(long commentId, String content) {
    SQLiteDatabase db = this.getWritableDatabase();
    ContentValues values = new ContentValues();
    values.put(COLUMN_COMMENT_CONTENT, content);
    
    return db.update(
        TABLE_NOTE_COMMENTS,
        values,
        COLUMN_COMMENT_ID + " = ?",
        new String[]{String.valueOf(commentId)}
    );
}
```

### 4.2 UIå±‚ï¼ˆMainActivityï¼‰

#### 4.2.1 æ‰©å±•ç¬”è®°æ“ä½œèœå•

```java
private void showNoteOptionsMenu(View anchorView, long noteId) {
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("é€‰æ‹©æ“ä½œ");
    
    // ä¿®æ”¹ï¼šæ·»åŠ "æ·»åŠ è¿½åŠ "é€‰é¡¹
    String[] options = {"å¤åˆ¶åˆ°å‰ªåˆ‡æ¿",  "æ·»åŠ è¿½åŠ ", "åˆ é™¤"};
    
    builder.setItems(options, (dialog, which) -> {
        switch (which) {
            case 0: // å¤åˆ¶åˆ°å‰ªåˆ‡æ¿
                copyToClipboard(noteId);
                break;
            case 1: // æ·»åŠ è¿½åŠ ï¼ˆæ–°å¢ï¼‰
                showAddCommentDialog(noteId);
                break;
            case 2: // åˆ é™¤
                showDeleteConfirmDialog(noteId);
                break;
        }
    });
    
    // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
}
```

#### 4.2.2 åœ¨åˆ—è¡¨é¡¹ä¸­æ˜¾ç¤ºè¿½åŠ å†…å®¹

ä¿®æ”¹ `updateListItemWithExtras()` æ–¹æ³•ï¼š

```java
private void updateListItemWithExtras(View view, long noteId, double cost) {
    // ... ç°æœ‰ä»£ç ï¼ˆæ—¶é—´åŒºé—´ã€æ ‡ç­¾ï¼‰...
    
    // æ·»åŠ è¿½åŠ å†…å®¹ä¿¡æ¯
    addCommentsInfo(extrasContainer, noteId);
}

/**
 * æ·»åŠ è¿½åŠ å†…å®¹ä¿¡æ¯åˆ°åˆ—è¡¨é¡¹
 */
private void addCommentsInfo(LinearLayout container, long noteId) {
    int commentCount = dbHelper.getCommentCount(noteId);
    
    if (commentCount > 0) {
        // åˆ›å»ºè¿½åŠ å†…å®¹å®¹å™¨
        LinearLayout commentsContainer = new LinearLayout(this);
        commentsContainer.setOrientation(LinearLayout.VERTICAL);
        commentsContainer.setPadding(dpToPx(8), dpToPx(8), dpToPx(8), dpToPx(8));
        commentsContainer.setBackgroundColor(0xFFF5F5F5); // æµ…ç°è‰²èƒŒæ™¯
        
        // åˆ›å»ºæ ‡é¢˜è¡Œï¼ˆå¯ç‚¹å‡»å±•å¼€/æŠ˜å ï¼‰
        LinearLayout headerLayout = new LinearLayout(this);
        headerLayout.setOrientation(LinearLayout.HORIZONTAL);
        headerLayout.setPadding(dpToPx(4), dpToPx(4), dpToPx(4), dpToPx(4));
        
        TextView headerText = new TextView(this);
        headerText.setText("ğŸ’¬ è¿½åŠ å†…å®¹ (" + commentCount + "æ¡)");
        headerText.setTextColor(0xFF2196F3); // è“è‰²
        headerText.setTextSize(14);
        headerText.setTypeface(null, Typeface.BOLD);
        
        // å­˜å‚¨å±•å¼€çŠ¶æ€ï¼ˆä½¿ç”¨noteIdä½œä¸ºkeyï¼‰
        boolean isExpanded = expandedComments.contains(noteId);
        
        // è®¾ç½®ç‚¹å‡»äº‹ä»¶ï¼ˆå±•å¼€/æŠ˜å ï¼‰
        headerLayout.setOnClickListener(v -> {
            toggleCommentsExpanded(noteId, commentsContainer);
        });
        
        headerLayout.addView(headerText);
        commentsContainer.addView(headerLayout);
        
        // å¦‚æœå±•å¼€ï¼Œæ˜¾ç¤ºæ‰€æœ‰è¿½åŠ å†…å®¹
        if (isExpanded) {
            displayComments(commentsContainer, noteId);
        }
        
        container.addView(commentsContainer);
    }
}

// å­˜å‚¨å±•å¼€çŠ¶æ€çš„Set
private Set<Long> expandedComments = new HashSet<>();

/**
 * åˆ‡æ¢è¿½åŠ å†…å®¹çš„å±•å¼€/æŠ˜å çŠ¶æ€
 */
private void toggleCommentsExpanded(long noteId, LinearLayout container) {
    if (expandedComments.contains(noteId)) {
        // æŠ˜å ï¼šç§»é™¤è¿½åŠ å†…å®¹è§†å›¾ï¼Œåªä¿ç•™æ ‡é¢˜
        expandedComments.remove(noteId);
        // ç§»é™¤é™¤æ ‡é¢˜å¤–çš„æ‰€æœ‰å­è§†å›¾
        while (container.getChildCount() > 1) {
            container.removeViewAt(1);
        }
    } else {
        // å±•å¼€ï¼šæ˜¾ç¤ºæ‰€æœ‰è¿½åŠ å†…å®¹
        expandedComments.add(noteId);
        displayComments(container, noteId);
    }
}

/**
 * æ˜¾ç¤ºæ‰€æœ‰è¿½åŠ å†…å®¹
 */
private void displayComments(LinearLayout container, long noteId) {
    Cursor commentsCursor = dbHelper.getCommentsForNote(noteId);
    
    if (commentsCursor != null && commentsCursor.getCount() > 0) {
        // æ·»åŠ åˆ†éš”çº¿
        View divider = new View(this);
        divider.setLayoutParams(new LinearLayout.LayoutParams(
            LinearLayout.LayoutParams.MATCH_PARENT, 1));
        divider.setBackgroundColor(0xFFCCCCCC);
        container.addView(divider);
        
        while (commentsCursor.moveToNext()) {
            long commentId = commentsCursor.getLong(
                commentsCursor.getColumnIndexOrThrow(NoteDbHelper.COLUMN_COMMENT_ID));
            String content = commentsCursor.getString(
                commentsCursor.getColumnIndexOrThrow(NoteDbHelper.COLUMN_COMMENT_CONTENT));
            long timestamp = commentsCursor.getLong(
                commentsCursor.getColumnIndexOrThrow(NoteDbHelper.COLUMN_COMMENT_TIMESTAMP));
            double cost = commentsCursor.getDouble(
                commentsCursor.getColumnIndexOrThrow(NoteDbHelper.COLUMN_COMMENT_COST));
            
            // åˆ›å»ºè¿½åŠ å†…å®¹é¡¹
            LinearLayout commentItem = new LinearLayout(this);
            commentItem.setOrientation(LinearLayout.VERTICAL);
            commentItem.setPadding(dpToPx(8), dpToPx(4), dpToPx(8), dpToPx(4));
            
            // æ—¶é—´æˆ³
            TextView timeText = new TextView(this);
            timeText.setText(formatTimestamp(timestamp));
            timeText.setTextColor(0xFF666666);
            timeText.setTextSize(12);
            commentItem.addView(timeText);
            
            // å†…å®¹
            TextView contentText = new TextView(this);
            contentText.setText(content);
            contentText.setTextSize(14);
            contentText.setPadding(0, dpToPx(2), 0, 0);
            commentItem.addView(contentText);
            
            // èŠ±è´¹ï¼ˆå¦‚æœæœ‰ï¼‰
            if (showCost && cost > 0) {
                TextView costText = new TextView(this);
                costText.setText(String.format("èŠ±è´¹: Â¥%.2f", cost));
                costText.setTextColor(0xFF4CAF50);
                costText.setTextSize(12);
                costText.setPadding(0, dpToPx(2), 0, 0);
                commentItem.addView(costText);
            }
            
            // æ·»åŠ "æ·»åŠ è¿½åŠ "æŒ‰é’®ï¼ˆå›å¤è¯¥è¯„è®ºï¼‰
            Button addReplyButton = new Button(this);
            addReplyButton.setText("æ·»åŠ è¿½åŠ ");
            addReplyButton.setOnClickListener(v -> {
                showAddCommentDialog(noteId, commentId); // ä¼ å…¥çˆ¶è¯„è®ºID
            });
            addReplyButton.setLayoutParams(new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.WRAP_CONTENT,
                LinearLayout.LayoutParams.WRAP_CONTENT));
            commentItem.addView(addReplyButton);
            
            // é•¿æŒ‰åˆ é™¤
            commentItem.setOnLongClickListener(v -> {
                showDeleteCommentDialog(commentId, noteId);
                return true;
            });
            
            container.addView(commentItem);
        }
        commentsCursor.close();
        
        // æ·»åŠ "æ·»åŠ è¿½åŠ "æŒ‰é’®
        Button addCommentButton = new Button(this);
        addCommentButton.setText("æ·»åŠ è¿½åŠ ");
        addCommentButton.setOnClickListener(v -> {
            showAddCommentDialog(noteId);
        });
        addCommentButton.setLayoutParams(new LinearLayout.LayoutParams(
            LinearLayout.LayoutParams.MATCH_PARENT,
            LinearLayout.LayoutParams.WRAP_CONTENT));
        addCommentButton.setPadding(dpToPx(8), dpToPx(8), dpToPx(8), dpToPx(8));
        container.addView(addCommentButton);
    }
}
```

#### 4.2.3 æ·»åŠ è¿½åŠ å†…å®¹å¯¹è¯æ¡†

```java
/**
 * æ˜¾ç¤ºæ·»åŠ è¿½åŠ å†…å®¹å¯¹è¯æ¡†
 */
private void showAddCommentDialog(long noteId) {
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("æ·»åŠ è¿½åŠ å†…å®¹");
    
    // åˆ›å»ºè¾“å…¥è§†å›¾
    LinearLayout layout = new LinearLayout(this);
    layout.setOrientation(LinearLayout.VERTICAL);
    layout.setPadding(dpToPx(16), dpToPx(16), dpToPx(16), dpToPx(16));
    
    EditText contentEdit = new EditText(this);
    contentEdit.setHint("è¾“å…¥è¿½åŠ å†…å®¹...");
    contentEdit.setMinLines(3);
    contentEdit.setMaxLines(5);
    contentEdit.setInputType(InputType.TYPE_CLASS_TEXT | InputType.TYPE_TEXT_FLAG_MULTI_LINE);
    layout.addView(contentEdit);
    
    // å¯é€‰ï¼šèŠ±è´¹è¾“å…¥
    EditText costEdit = new EditText(this);
    costEdit.setHint("èŠ±è´¹é‡‘é¢ï¼ˆå¯é€‰ï¼‰");
    costEdit.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_FLAG_DECIMAL);
    layout.addView(costEdit);
    
    builder.setView(layout);
    
    builder.setPositiveButton("æ·»åŠ ", (dialog, which) -> {
        String content = contentEdit.getText().toString().trim();
        if (content.isEmpty()) {
            Toast.makeText(this, "è¯·è¾“å…¥å†…å®¹", Toast.LENGTH_SHORT).show();
            return;
        }
        
        double cost = 0.0;
        String costText = costEdit.getText().toString().trim();
        if (!costText.isEmpty()) {
            try {
                cost = Double.parseDouble(costText);
            } catch (NumberFormatException e) {
                Toast.makeText(this, "èŠ±è´¹é‡‘é¢æ ¼å¼ä¸æ­£ç¡®", Toast.LENGTH_SHORT).show();
                return;
            }
        }
        
        // ä¿å­˜è¿½åŠ å†…å®¹
        long commentId = dbHelper.addComment(noteId, content, cost);
        if (commentId != -1) {
            Toast.makeText(this, "è¿½åŠ æˆåŠŸ", Toast.LENGTH_SHORT).show();
            // åˆ·æ–°è¯¥ç¬”è®°çš„æ˜¾ç¤º
            refreshNoteView(noteId);
        } else {
            Toast.makeText(this, "è¿½åŠ å¤±è´¥", Toast.LENGTH_SHORT).show();
        }
    });
    
    builder.setNegativeButton("å–æ¶ˆ", null);
    builder.show();
}

/**
 * æ˜¾ç¤ºåˆ é™¤è¿½åŠ å†…å®¹ç¡®è®¤å¯¹è¯æ¡†
 */
private void showDeleteCommentDialog(long commentId, long noteId) {
    AlertDialog.Builder builder = new AlertDialog.Builder(this);
    builder.setTitle("åˆ é™¤è¿½åŠ å†…å®¹");
    builder.setMessage("ç¡®å®šè¦åˆ é™¤è¿™æ¡è¿½åŠ å†…å®¹å—ï¼Ÿ");
    
    builder.setPositiveButton("åˆ é™¤", (dialog, which) -> {
        int result = dbHelper.deleteComment(commentId);
        if (result > 0) {
            Toast.makeText(this, "å·²åˆ é™¤", Toast.LENGTH_SHORT).show();
            refreshNoteView(noteId);
        } else {
            Toast.makeText(this, "åˆ é™¤å¤±è´¥", Toast.LENGTH_SHORT).show();
        }
    });
    
    builder.setNegativeButton("å–æ¶ˆ", null);
    builder.show();
}
```

---

## äº”ã€æ˜¾ç¤ºä¼˜åŒ–

### 5.1 æŠ˜å /å±•å¼€çŠ¶æ€æŒä¹…åŒ–

```java
// åœ¨onCreateä¸­åŠ è½½
private void loadExpandedComments() {
    SharedPreferences prefs = getSharedPreferences("noteplus_prefs", MODE_PRIVATE);
    String expandedStr = prefs.getString("expanded_comments", "");
    if (!expandedStr.isEmpty()) {
        String[] ids = expandedStr.split(",");
        for (String id : ids) {
            try {
                expandedComments.add(Long.parseLong(id));
            } catch (NumberFormatException e) {
                // å¿½ç•¥æ— æ•ˆID
            }
        }
    }
}

// åœ¨onDestroyä¸­ä¿å­˜
private void saveExpandedComments() {
    SharedPreferences prefs = getSharedPreferences("noteplus_prefs", MODE_PRIVATE);
    SharedPreferences.Editor editor = prefs.edit();
    StringBuilder sb = new StringBuilder();
    for (Long id : expandedComments) {
        if (sb.length() > 0) sb.append(",");
        sb.append(id);
    }
    editor.putString("expanded_comments", sb.toString());
    editor.apply();
}
```

### 5.2 æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡åˆ·æ–°**ï¼šæ·»åŠ è¿½åŠ å†…å®¹åï¼Œåªåˆ·æ–°è¯¥ç¬”è®°çš„è§†å›¾

---

## å…­ã€å¯¼å…¥å¯¼å‡ºæ”¯æŒ

### 6.1 å¯¼å‡ºæ—¶åŒ…å«è¿½åŠ å†…å®¹

åœ¨ `writeJsonData()` å’Œ `writeCsvData()` ä¸­æ·»åŠ ï¼š

```java
// è·å–è¿½åŠ å†…å®¹
Cursor commentsCursor = dbHelper.getCommentsForNote(noteId);
JSONArray commentsArray = new JSONArray();
while (commentsCursor.moveToNext()) {
    JSONObject comment = new JSONObject();
    comment.put("content", commentsCursor.getString(...));
    comment.put("timestamp", sdf.format(new Date(commentsCursor.getLong(...))));
    comment.put("cost", commentsCursor.getDouble(...));
    commentsArray.put(comment);
}
commentsCursor.close();
noteObject.put("comments", commentsArray);
```

### 6.2 å¯¼å…¥æ—¶æ¢å¤è¿½åŠ å†…å®¹

åœ¨ `readJsonData()` ä¸­æ·»åŠ ï¼š

```java
if (noteObject.has("comments")) {
    JSONArray commentsArray = noteObject.getJSONArray("comments");
    for (int j = 0; j < commentsArray.length(); j++) {
        JSONObject comment = commentsArray.getJSONObject(j);
        String content = comment.getString("content");
        long timestamp = sdf.parse(comment.getString("timestamp")).getTime();
        double cost = comment.optDouble("cost", 0.0);
        dbHelper.addComment(newNoteId, content, cost);
    }
}
```

---

## ä¸ƒã€å®ç°ä¼˜å…ˆçº§

### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰
1. âœ… æ•°æ®åº“è¡¨åˆ›å»ºå’Œå‡çº§
2. âœ… æ•°æ®åº“æ“ä½œæ–¹æ³•ï¼ˆaddComment, getCommentsForNoteç­‰ï¼‰
3. âœ… åœ¨åˆ—è¡¨é¡¹ä¸­æ˜¾ç¤ºè¿½åŠ å†…å®¹æ•°é‡
4. âœ… æ·»åŠ è¿½åŠ å†…å®¹å¯¹è¯æ¡†

### é˜¶æ®µ2ï¼šäº¤äº’ä¼˜åŒ–ï¼ˆå¿…é¡»ï¼‰
1. âœ… å±•å¼€/æŠ˜å åŠŸèƒ½
2. âœ… æ˜¾ç¤ºè¿½åŠ å†…å®¹åˆ—è¡¨
3. âœ… åˆ é™¤è¿½åŠ å†…å®¹åŠŸèƒ½

### é˜¶æ®µ3ï¼šä½“éªŒä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. âš ï¸ å±•å¼€çŠ¶æ€æŒä¹…åŒ–
2. âš ï¸ ç¼–è¾‘è¿½åŠ å†…å®¹åŠŸèƒ½
3. âš ï¸ è¿½åŠ å†…å®¹æ”¯æŒæ ‡ç­¾
4. âš ï¸ å¯¼å…¥å¯¼å‡ºæ”¯æŒ

---

## å…«ã€æ³¨æ„äº‹é¡¹

### 8.1 æ•°æ®ä¸€è‡´æ€§
- åˆ é™¤ç¬”è®°æ—¶ï¼Œçº§è”åˆ é™¤æ‰€æœ‰è¿½åŠ å†…å®¹ï¼ˆé€šè¿‡å¤–é”®çº¦æŸï¼‰
- è¿½åŠ å†…å®¹çš„æ—¶é—´æˆ³ä½¿ç”¨ç³»ç»Ÿå½“å‰æ—¶é—´
- ç§»åŠ¨ç¬”è®°åˆ°å…¶ä»–é¡¹ç›®çš„æ—¶å€™ï¼ŒæŠŠè¯„è®ºä¸€å¹¶ç§»åŠ¨äº†ã€‚

### 8.2 æ€§èƒ½è€ƒè™‘
- å¦‚æœï¼Œè¿½åŠ å†…å®¹æ•°é‡å¤šæ—¶ï¼Œè€ƒè™‘åˆ†é¡µåŠ è½½ï¼ˆå…ˆæç½®ï¼‰

### 8.3 ç”¨æˆ·ä½“éªŒ
- è¿½åŠ å†…å®¹æ•°é‡ä¸º0æ—¶ä¸æ˜¾ç¤º
- å±•å¼€/æŠ˜å åŠ¨ç”»ï¼ˆå…ˆæç½®ï¼‰
- æ·»åŠ è¿½åŠ å†…å®¹åè‡ªåŠ¨å±•å¼€å¹¶æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„å†…å®¹

### 8.4 æ‰©å±•æ€§
- å¯ä»¥æ”¯æŒè¿½åŠ å†…å®¹çš„é™„ä»¶ï¼ˆå›¾ç‰‡ç­‰ï¼‰

---

## ä¹ã€æ€»ç»“

### æ¨èæ–¹æ¡ˆ
**æ–¹æ¡ˆ1ï¼šåœ¨åˆ—è¡¨é¡¹ä¸­å±•å¼€æ˜¾ç¤º**ï¼ˆé€‰ä¸­ï¼‰

### ä¼˜åŠ¿
- âœ… å®ç°ç®€å•ï¼Œä¸éœ€è¦æ–°å»ºé¡µé¢
- âœ… ç”¨æˆ·ä½“éªŒç›´è§‚ï¼Œç¬¦åˆç°æœ‰è®¾è®¡
- âœ… å¯ä»¥å¿«é€ŸæŸ¥çœ‹å’Œæ·»åŠ è¿½åŠ å†…å®¹
- âœ… æ˜“äºæ‰©å±•

### é¢„è®¡å·¥ä½œé‡
- æ•°æ®åº“å±‚ï¼š1ä¸ªè¡¨ï¼Œ5ä¸ªæ–¹æ³•ï¼Œçº¦150è¡Œä»£ç 
- UIå±‚ï¼š4ä¸ªæ–¹æ³•ï¼Œçº¦300è¡Œä»£ç 
- å¸ƒå±€ä¼˜åŒ–ï¼šçº¦50è¡Œä»£ç 
- **æ€»è®¡ï¼šçº¦500è¡Œä»£ç **

### å®ç°éš¾åº¦
- â­â­â­â˜†â˜†ï¼ˆä¸­ç­‰ï¼Œä¸»è¦æ˜¯UIäº¤äº’é€»è¾‘ï¼‰

### ä¸æ ‡ç­¾ç®¡ç†çš„å…³ç³»ï¼ˆå…ˆæç½®ï¼‰
- å¯ä»¥ç»“åˆä½¿ç”¨ï¼šæ·»åŠ è¿½åŠ å†…å®¹æ—¶ä¹Ÿå¯ä»¥æ·»åŠ æ ‡ç­¾
- è¿½åŠ å†…å®¹ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„æ ‡ç­¾ï¼ˆæœªæ¥æ‰©å±•ï¼‰

